import{a as w,m as x,_ as N,v as e}from"./app-D4g4NRDO.js";import{I as S,L as U,C as E}from"./ICode-DW8xAcp5.js";const T={name:"UserChoose",components:{ICode:S,Loading:U,Code:E},props:{group:Object,role:{type:String,default:"disciple"}},data(){return{search:"",dialog:!1,surname:"",name:"",patronymic:"",phone:"",usersHeaders:[{title:"ФИО",key:"name"},{title:"Телефон",key:"phone"},{title:"link",sortable:!1,key:"link"}]}},methods:{...w("users",["actUserCreateLink","actReqwestUsers","actUserCreate"]),...w("administrator",["actJoinUserToGroup","actRequestGroupUsers"]),create(){this.actUserCreate({surname:this.surname,name:this.name,patronymic:this.patronymic,phone:this.phone,role:this.role}).then(t=>{t&&(this.search=this.phone.replace(/^8/,7),this.surname="",this.name="",this.patronymic="",this.phone="")})},async choose(t){await this.actJoinUserToGroup({groupId:this.group.id,userId:t,role:this.role}),this.$emit("choosedUser")}},computed:{...x("users",["getUsers","getLoad"]),searchItems(){return this.search?this.getUsers.filter(t=>{var o,n;return((o=t.phone)==null?void 0:o.search(this.search))>-1||((n=t.surname)==null?void 0:n.search(this.search))>-1}):this.getUsers},canCreate(){return!!this.phone&&!!this.surname&&!!this.name}},created(){this.actReqwestUsers({role:this.role})}},G={class:"tw-flex tw-flex-col md:tw-flex-row tw-gap-[15px] tw-mb-5 tw-justify-center"},I={class:"tw-w-full tw-grid tw-gap-2 tw-grid-cols-1 md:tw-grid-cols-2 xl:tw-grid-cols-4"},L={key:0},R={class:"tw-flex tw-flex-col md:tw-flex-row tw-justify-between"},j={class:"tw-w-full"},q=["onClick"],A=["onClick"];function z(t,o,n,d,r,s){const i=e.resolveComponent("v-text-field"),v=e.resolveComponent("v-btn"),u=e.resolveComponent("v-divider"),m=e.resolveComponent("v-skeleton-loader"),f=e.resolveComponent("Code"),g=e.resolveComponent("v-data-table"),p=e.resolveComponent("v-card-text"),k=e.resolveComponent("v-card"),y=e.resolveComponent("Loading");return t.getUsers?(e.openBlock(),e.createBlock(k,{key:0},{default:e.withCtx(()=>[e.createVNode(p,null,{default:e.withCtx(()=>[e.createElementVNode("div",G,[e.createElementVNode("div",I,[e.createVNode(i,{label:"Фамилия",modelValue:r.surname,"onUpdate:modelValue":o[0]||(o[0]=a=>r.surname=a)},null,8,["modelValue"]),e.createVNode(i,{label:"Имя",modelValue:r.name,"onUpdate:modelValue":o[1]||(o[1]=a=>r.name=a)},null,8,["modelValue"]),e.createVNode(i,{label:"Отчество",modelValue:r.patronymic,"onUpdate:modelValue":o[2]||(o[2]=a=>r.patronymic=a)},null,8,["modelValue"]),e.createVNode(i,{label:"Телефон",type:"number",modelValue:r.phone,"onUpdate:modelValue":o[3]||(o[3]=a=>r.phone=a)},null,8,["modelValue"])]),e.createVNode(v,{class:"tw-mt-2",color:"primary",disabled:!s.canCreate,onClick:s.create},{default:e.withCtx(()=>[e.createTextVNode(" Создать нового пользователя ")]),_:1},8,["disabled","onClick"])]),e.createVNode(u,{class:"tw-my-3",color:"blue"}),t.getUsers?(e.openBlock(),e.createElementBlock("div",L,[e.createElementVNode("div",R,[e.createElementVNode("div",j,[e.createVNode(i,{clearable:"","persistent-clear":"",label:"Поиск по фамилии/телефону",modelValue:r.search,"onUpdate:modelValue":o[4]||(o[4]=a=>r.search=a)},null,8,["modelValue"])])]),e.createVNode(g,{"onClick:row":o[5]||(o[5]=a=>r.dialog=!r.dialog),headers:r.usersHeaders,items:s.searchItems,loading:t.getLoad},{"item.name":e.withCtx(({item:a})=>[e.createElementVNode("div",{onClick:V=>s.choose(a.id)},e.toDisplayString(a.surname)+" "+e.toDisplayString(a.name)+" "+e.toDisplayString(a.patronymic),9,q)]),loading:e.withCtx(()=>[e.createVNode(m,{type:"table-row@10"})]),"item.link":e.withCtx(({item:a})=>[a.entry_code?(e.openBlock(),e.createBlock(f,{key:0,code:a.entry_code},null,8,["code"])):(e.openBlock(),e.createElementBlock("div",{key:1,onClick:V=>t.actUserCreateLink({uid:a.id})}," сгенерить ключ ",8,A))]),_:1},8,["headers","items","loading"])])):e.createCommentVNode("",!0)]),_:1})]),_:1})):(e.openBlock(),e.createBlock(y,{key:1}))}const O=N(T,[["render",z]]),F={name:"DetailGroup",components:{UserChoose:O},data(){return{dialogDisciple:!1,dialogTeacher:!1,dialogDate:!1,newDate:new Date,now:"day3"}},computed:{...x("administrator",["getGroup","getDisciples","getTeachers","getAttendances","getCourse","getLessons","getStudyProgram","getSchedule"]),headers(){let t=[{title:"Имя",align:"center",key:"name",width:"300px",fixed:!0,sortable:!1,divider:!0}];for(const o in this.getSchedule){let n=this.getSchedule[o];t.push({title:n.order,align:"center",key:"day"+n.id,id:n.id,width:"20px",sortable:!1})}return t.push({title:"",key:"",sortable:!1}),t},groupId(){return this.$route.params.id},headersNotEmpty(){return this.headers.map(t=>{if(t.key!=="name"&&t.key!=="")return t.lessons=this.lessonsDays[t.id],t})},lessonsDays(){let t={};for(const o in this.getLessons){let n=this.getLessons[o],d=n.school_day;d&&(t[d]||(t[d]=[]),t[d].push(n.name))}return t},disciples(){let t=[];for(const o in this.getDisciples){let n=this.getDisciples[o],d=(n.surname??"")+" "+(n.name??"")+" ["+n.phone+"]";t.push({id:n.id,name:d,status:n.status,expelled_at:n.expelled_at})}return t},groupsSchoolDays(){return this.getGroup.groups_school_day??{}},existsOpenDay(){let t=!1;for(const o in this.groupsSchoolDays)if(this.groupsSchoolDays[o].status=="open"){t=!0;break}return t},finishedCourse(){let t=0;for(const o in this.groupsSchoolDays){if(this.groupsSchoolDays[o].status=="open")break;t++}return t>=Object.keys(this.getSchedule).length},attendance:{get(){return this.getAttendances},set(){}}},methods:{...w("administrator",["actRequestGroup","actAddGroupSchoolDay","actCloseGroupSchoolDay","actRequestGroupUsers","actRemoveUserFromGroup","actRestoreUserToGroup","actRequestAttendances","actSetAttendance","actReqwestCourse"]),async addSchoolDay(){this.dialogDate=!1,await this.actAddGroupSchoolDay({groupId:this.getGroup.id,date:this.newDate}),this.newDate=new Date},async closeSchoolDay(){await this.actCloseGroupSchoolDay({groupId:this.getGroup.id})},lessons(t){let o=[];for(const n in t)o.push(1+parseInt(n)+". "+t[n]);return o.join("<br/>")},loadUsers(){this.actRequestGroupUsers({groupId:this.groupId})},removeTeacher(t){confirm("Удалить учителя?")&&this.actRemoveUserFromGroup({groupId:this.groupId,userId:t})},removeDisciple(t){confirm("Отчислить ученика?")&&this.actRemoveUserFromGroup({groupId:this.groupId,userId:t})},restoreDisciple(t){confirm("Восстановить ученика?")&&this.actRestoreUserToGroup({groupId:this.groupId,userId:t})},expelledDay(t,o){if(t.status!="expelled")return!1;let n=Date.parse(t.expelled_at);return Date.parse(this.groupsSchoolDays[o.id].dateOrigin)>n}},created(){this.loadUsers(),this.actRequestGroup(this.groupId).then(()=>{this.actReqwestCourse({id:this.getGroup.course_id})}),this.actRequestAttendances({groupId:this.groupId})}},H={class:"md:tw-flex tw-justify-between"},J={class:"tw-w-full tw-flex tw-justify-between"},M=e.createElementVNode("h6",null,"Добавить ученика",-1),P={class:"tw-w-full tw-flex tw-justify-between"},K=e.createElementVNode("h6",null,"Добавить учителя",-1),Q={class:"tw-w-full tw-flex tw-justify-between"},W=e.createElementVNode("h6",null,"Добавить учебный день",-1),X={class:"tw-mx-4"},Y={key:1},Z={key:2},$=e.createElementVNode("br",null,null,-1),ee=["innerHTML"],te={key:1},oe={key:1},le={key:0},se={key:1,class:"tw-text-gray"};function re(t,o,n,d,r,s){const i=e.resolveComponent("v-btn"),v=e.resolveComponent("v-chip"),u=e.resolveComponent("v-card-title"),m=e.resolveComponent("v-icon"),f=e.resolveComponent("UserChoose"),g=e.resolveComponent("v-card-text"),p=e.resolveComponent("v-card"),k=e.resolveComponent("v-dialog"),y=e.resolveComponent("v-date-picker"),a=e.resolveComponent("v-card-actions"),V=e.resolveComponent("v-tooltip"),D=e.resolveComponent("v-checkbox"),b=e.resolveComponent("v-data-table");return e.openBlock(),e.createBlock(p,null,{default:e.withCtx(()=>[e.createVNode(u,null,{default:e.withCtx(()=>[e.createElementVNode("div",H,[e.createElementVNode("div",null,'Группа "'+e.toDisplayString(t.getGroup.name)+'". Курс "'+e.toDisplayString(t.getCourse.name)+'"',1),s.existsOpenDay?(e.openBlock(),e.createBlock(i,{key:0,density:"comfortable",variant:"outlined",color:"primary",onClick:o[0]||(o[0]=l=>s.closeSchoolDay())},{default:e.withCtx(()=>[e.createTextVNode(" Закрыть день ")]),_:1})):s.finishedCourse?(e.openBlock(),e.createBlock(v,{key:2,class:"ma-2",color:"red"},{default:e.withCtx(()=>[e.createTextVNode(" Курс завершен ")]),_:1})):(e.openBlock(),e.createBlock(i,{key:1,density:"comfortable",variant:"outlined",color:"primary",onClick:o[1]||(o[1]=l=>r.dialogDate=!0)},{default:e.withCtx(()=>[e.createTextVNode(" Добавить день ")]),_:1}))])]),_:1}),e.createVNode(k,{modelValue:r.dialogDisciple,"onUpdate:modelValue":o[4]||(o[4]=l=>r.dialogDisciple=l)},{default:e.withCtx(()=>[e.createVNode(p,null,{default:e.withCtx(()=>[e.createVNode(u,null,{default:e.withCtx(()=>[e.createElementVNode("div",J,[M,e.createVNode(m,{onClick:o[2]||(o[2]=l=>r.dialogDisciple=!1)},{default:e.withCtx(()=>[e.createTextVNode("mdi-close")]),_:1})]),e.createVNode(g,null,{default:e.withCtx(()=>[e.createVNode(f,{onChoosedUser:o[3]||(o[3]=l=>{r.dialogDisciple=!1,s.loadUsers()}),group:t.getGroup},null,8,["group"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e.createVNode(k,{modelValue:r.dialogTeacher,"onUpdate:modelValue":o[7]||(o[7]=l=>r.dialogTeacher=l)},{default:e.withCtx(()=>[e.createVNode(p,null,{default:e.withCtx(()=>[e.createVNode(u,null,{default:e.withCtx(()=>[e.createElementVNode("div",P,[K,e.createVNode(m,{onClick:o[5]||(o[5]=l=>r.dialogTeacher=!1)},{default:e.withCtx(()=>[e.createTextVNode("mdi-close")]),_:1})]),e.createVNode(g,null,{default:e.withCtx(()=>[e.createVNode(f,{onChoosedUser:o[6]||(o[6]=l=>{r.dialogTeacher=!1,s.loadUsers()}),role:"teacher",group:t.getGroup},null,8,["group"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e.createVNode(k,{modelValue:r.dialogDate,"onUpdate:modelValue":o[10]||(o[10]=l=>r.dialogDate=l),width:"400"},{default:e.withCtx(()=>[e.createVNode(p,null,{default:e.withCtx(()=>[e.createVNode(u,null,{default:e.withCtx(()=>[e.createElementVNode("div",Q,[W,e.createVNode(m,{onClick:o[8]||(o[8]=l=>r.dialogDate=!1)},{default:e.withCtx(()=>[e.createTextVNode("mdi-close")]),_:1})]),e.createVNode(g,null,{default:e.withCtx(()=>[e.createVNode(y,{modelValue:r.newDate,"onUpdate:modelValue":o[9]||(o[9]=l=>r.newDate=l),title:"","hide-header":""},null,8,["modelValue"])]),_:1})]),_:1}),e.createVNode(a,null,{default:e.withCtx(()=>[e.createVNode(i,{text:"Создать",onClick:s.addSchoolDay},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e.createElementVNode("div",X,[e.createTextVNode(" Учителя: "),s.finishedCourse?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(i,{key:0,class:"ml-5",color:"green",icon:"mdi-account-plus",onClick:o[11]||(o[11]=l=>r.dialogTeacher=!0),variant:"flat",density:"compact",size:"x-large"})),Object.keys(t.getTeachers).length?(e.openBlock(),e.createElementBlock("span",Y,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.getTeachers,l=>(e.openBlock(),e.createBlock(v,{key:l.id,"model-value":!0,class:"ma-2",color:"teal",closable:!s.finishedCourse,"onClick:close":C=>s.removeTeacher(l.id)},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString([l.surname,l.name,l.phone].join(" ")),1)]),_:2},1032,["closable","onClick:close"]))),128))])):(e.openBlock(),e.createElementBlock("span",Z,"В группе пока нет учителей"))]),e.createVNode(b,{"items-per-page":-1,class:"table-sh",height:"800","fixed-header":"",density:"compact",items:s.disciples,headers:s.headers,"hide-default-footer":!0,"disable-pagination":""},e.createSlots({"item.name":e.withCtx(({item:l})=>[l.status!="expelled"?(e.openBlock(),e.createElementBlock("div",le,[e.createTextVNode(e.toDisplayString(l.name)+" ",1),s.finishedCourse?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(i,{key:0,class:"ml-5",color:"red",icon:"mdi-account-remove-outline",onClick:C=>s.removeDisciple(l.id),variant:"text",density:"compact",size:"small"},null,8,["onClick"]))])):(e.openBlock(),e.createElementBlock("div",se,[e.createTextVNode(e.toDisplayString(l.name)+" ",1),s.finishedCourse?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(i,{key:0,class:"ml-5",color:"green",icon:"mdi-account-plus",onClick:C=>s.restoreDisciple(l.id),variant:"text",density:"compact",size:"small"},null,8,["onClick"]))]))]),_:2},[e.renderList(s.headersNotEmpty,(l,C)=>({name:"header.name",fn:e.withCtx(({column:c})=>[e.createTextVNode(" УЧЕНИКИ "),s.finishedCourse?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(i,{key:0,class:"ml-5",color:"green",icon:"mdi-account-plus",onClick:o[12]||(o[12]=h=>r.dialogDisciple=!0),variant:"flat",density:"compact",size:"x-large"}))])})),e.renderList(s.headersNotEmpty,(l,C)=>({name:`header.day${l==null?void 0:l.id}`,fn:e.withCtx(({column:c})=>{var h,_;return[e.createElementVNode("div",{class:e.normalizeClass({activeSlot:((h=s.groupsSchoolDays[l.id])==null?void 0:h.status)=="open"})},[e.createTextVNode(e.toDisplayString(c.title)+" ",1),$,e.createVNode(V,{location:"top"},{activator:e.withCtx(({props:B})=>[e.createVNode(m,e.mergeProps(B,{color:"grey",size:"small"}),{default:e.withCtx(()=>[e.createTextVNode("mdi-book-open-outline")]),_:2},1040)]),default:e.withCtx(()=>[e.createElementVNode("span",{innerHTML:s.lessons(l.lessons)},null,8,ee)]),_:2},1024),(_=s.groupsSchoolDays[l.id])!=null&&_.date?(e.openBlock(),e.createElementBlock("div",{key:0,style:e.normalizeStyle({color:s.groupsSchoolDays[l.id].status!=="open"?"grey":"black"})},e.toDisplayString(s.groupsSchoolDays[l.id].date),5)):(e.openBlock(),e.createElementBlock("div",te,"?"))],2)]})})),e.renderList(s.headersNotEmpty,(l,C)=>({name:`item.day${l==null?void 0:l.id}`,fn:e.withCtx(({item:c})=>{var h;return[(t.gsd=s.groupsSchoolDays[l.id])?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[s.expelledDay(c,l)?(e.openBlock(),e.createElementBlock("div",oe,"-")):(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass({activeSlot:((h=t.gsd)==null?void 0:h.status)==="open"})},[e.createVNode(D,{color:"green","hide-details":"",density:"compact",style:{"text-align":"center"},modelValue:s.attendance,"onUpdate:modelValue":o[13]||(o[13]=_=>s.attendance=_),disabled:t.gsd.status!=="open"||c.status=="expelled",value:t.gsd.id+"_"+c.id,onChange:_=>t.actSetAttendance({groupSchoolDayId:s.groupsSchoolDays[l.id].id,userId:c.id})},null,8,["modelValue","disabled","value","onChange"])],2))],64)):e.createCommentVNode("",!0)]})}))]),1032,["items","headers"])]),_:1})}const ie=N(F,[["render",re]]);export{ie as default};
